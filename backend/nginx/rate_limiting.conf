# Nginx Rate Limiting Configuration for NestFind Authentication
# Place this configuration in your nginx.conf

# ============================================================================
# STEP 1: Define rate limit zones in http {} block
# ============================================================================

http {
    # Rate limit zones (IP-based)
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;
    limit_req_zone $binary_remote_addr zone=otp_generate_limit:10m rate=3r/m;
    limit_req_zone $binary_remote_addr zone=otp_verify_limit:10m rate=10r/m;
    limit_req_zone $binary_remote_addr zone=refresh_limit:10m rate=5r/m;
    
    # Custom 429 response
    limit_req_status 429;
    
    # ... other http configuration ...
    
    server {
        listen 80;
        server_name api.nestfind.com;
        
        # ============================================================================
        # STEP 2: Apply rate limits to specific endpoints in server {} block
        # ============================================================================
        
        # Login endpoint - 5 requests per minute per IP
        location = /auth/login {
            limit_req zone=login_limit burst=0 nodelay;
            limit_req_log_level warn;
            
            proxy_pass http://localhost:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # OTP generation - 3 requests per minute per IP
        location = /auth/otp/generate {
            limit_req zone=otp_generate_limit burst=0 nodelay;
            limit_req_log_level warn;
            
            proxy_pass http://localhost:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # OTP verification - 10 requests per minute per IP
        location = /auth/otp/verify {
            limit_req zone=otp_verify_limit burst=0 nodelay;
            limit_req_log_level warn;
            
            proxy_pass http://localhost:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Token refresh - 5 requests per minute per IP
        location = /auth/refresh {
            limit_req zone=refresh_limit burst=0 nodelay;
            limit_req_log_level warn;
            
            proxy_pass http://localhost:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # All other endpoints (no rate limiting)
        location / {
            proxy_pass http://localhost:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

# ============================================================================
# PRODUCTION DEPLOYMENT NOTES
# ============================================================================

# If behind AWS ALB / Cloudflare / Load Balancer:
# Replace $binary_remote_addr with $http_x_forwarded_for in limit_req_zone
# 
# Example for production:
# limit_req_zone $http_x_forwarded_for zone=login_limit:10m rate=5r/m;
#
# WARNING: Only use X-Forwarded-For if you trust the upstream proxy
# Otherwise attackers can spoof IPs

# ============================================================================
# VERIFICATION
# ============================================================================

# Test rate limiting:
# curl -X POST http://localhost/auth/login -d '{"email":"test@test.com","password":"test"}' -H "Content-Type: application/json"
# Repeat 6 times rapidly - 6th request should return HTTP 429

# ============================================================================
# RESPONSE ON LIMIT EXCEEDED
# ============================================================================

# HTTP 429 Too Many Requests
# Body: <html><head><title>429 Too Many Requests</title></head><body><center><h1>429 Too Many Requests</h1></center></body></html>
